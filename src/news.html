<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>News Feed</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="news.html">NewsPortal</a>
            <div class="d-flex" id="nav-user"></div>
        </div>
    </nav>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Latest News</h1>
            <a href="create.html" class="btn btn-success">+ Create News</a>
        </div>

        <div id="news-container" class="row g-4">
            <!-- News items injected here -->
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        requireAuth();
        updateNavbar();

        async function loadNews() {
            const res = await apiFetch('/news');
            const newsList = await res.json();
            const container = document.getElementById('news-container');
            const currentUser = getCurrentUser();

            // Fetch users to resolve author names
            const usersRes = await apiFetch('/users');
            const users = await usersRes.json();
            const getUserName = (id) => users.find(u => u.id == id)?.name || "Unknown";

            container.innerHTML = newsList.map(item => {
                const isAuthor = currentUser.id == item.author_id;
                
                return `
                <div class="col-md-6">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">${item.title}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">By ${getUserName(item.author_id)}</h6>
                            <p class="card-text">${item.body.substring(0, 100)}...</p>
                            
                            <a href="detail.html?id=${item.id}" class="btn btn-primary btn-sm">Read More</a>
                            
                            ${isAuthor ? `
                                <a href="edit.html?id=${item.id}" class="btn btn-warning btn-sm">Edit</a>
                                <button onclick="deleteNews(${item.id})" class="btn btn-danger btn-sm">Delete</button>
                            ` : ''}
                        </div>
                        <div class="card-footer text-muted">
                            ${item.comments.length} Comments
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        async function deleteNews(id) {
            if(!confirm("Are you sure you want to delete this news?")) return;
            
            const res = await apiFetch(`/news/${id}`, { method: 'DELETE' });
            if(res.ok) {
                loadNews(); // Refresh list
            } else {
                const data = await res.json();
                alert(data.error);
            }
        }

        loadNews();
    </script>
</body>
</html>